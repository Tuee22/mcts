#!/bin/bash
#
# Pre-commit hook to check for unpaired UTF-16 surrogates
# This prevents the "no low surrogate" error in Claude Code workflows
#

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

echo -e "${YELLOW}üîç Checking staged files for unpaired UTF-16 surrogates...${NC}"

# Check if Node.js is available
if ! command -v node &> /dev/null; then
    echo -e "${RED}‚ùå Error: Node.js is required for surrogate checking${NC}"
    echo "Please install Node.js or run manually: npm run sanitize:check"
    exit 1
fi

# Get list of staged text files
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.(js|jsx|ts|tsx|json|py|pyi|md|txt|yml|yaml|toml|sh|css|html|xml|c|cpp|h|hpp)$' || true)

if [ -z "$STAGED_FILES" ]; then
    echo -e "${GREEN}‚úÖ No text files staged for commit${NC}"
    exit 0
fi

# Create temp directory for checking only staged files
TEMP_DIR=$(mktemp -d)
trap "rm -rf $TEMP_DIR" EXIT

# Copy staged versions of files to temp directory
echo "$STAGED_FILES" | while read -r file; do
    if [ -f "$file" ]; then
        mkdir -p "$TEMP_DIR/$(dirname "$file")"
        git show :"$file" > "$TEMP_DIR/$file" 2>/dev/null || cp "$file" "$TEMP_DIR/$file"
    fi
done

# Run sanitizer on staged files
cd "$(git rev-parse --show-toplevel)"
if node tools/sanitize.js --check --verbose > "$TEMP_DIR/sanitize_output" 2>&1; then
    echo -e "${GREEN}‚úÖ No unpaired surrogates found in staged files${NC}"
    exit 0
else
    echo -e "${RED}‚ùå Found unpaired UTF-16 surrogates in staged files:${NC}"
    echo ""
    cat "$TEMP_DIR/sanitize_output"
    echo ""
    echo -e "${YELLOW}üí° To fix these issues:${NC}"
    echo "   1. Run: npm run sanitize:fix"
    echo "   2. Review and stage the fixes"
    echo "   3. Commit again"
    echo ""
    echo -e "${YELLOW}‚ö†Ô∏è  These surrogates can cause 'no low surrogate' errors in Claude Code${NC}"
    exit 1
fi